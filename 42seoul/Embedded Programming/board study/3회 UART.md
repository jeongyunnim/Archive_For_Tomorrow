---
날짜: "2025-02-06"
넘버: 
태그: 프로그래밍/임베디드
출처: 
aliases:
---
### 날짜:  2025-02-06 18:20

### 태그: #프로그래밍/임베디드

>[!메모]
>

### 원문
---
# 3회 UART
## 시리얼 통신과 UART 통신
### 시리얼 통신과 병렬 통신
- 병렬통신은 거리가 멀 수록 와이어의 길이를 맞춰야 한다.
	- 구부러지는 경우, 의도치 않은 저항이 생길 수 있기 때문에 수신 시에 시간 차가 생길 수 있다.
#### 직렬(serial) 형태
- 단일 선로로 한 시점에 한 비트가 보내진다.
- 8개의 비트를 보내기 위해 8개의 **시간 간격**이 필요하다.
- 사용 예시
	- 임베디드 시스템
	- 장거리 통신
	- 고속 인터페이스(USB, PCI Express)
#### 병렬(Parallel) 형태
- 모든 비트가 동일한 시간에 별개의 라인으로 보내진다.
- 각 비트에 하나의 라인, 하나의 시간 간격이 필요하다.
- 사용 예시
	- 컴퓨터 내부의 데이터 버스
	- 단거리 고속 데이터 전송
![[Excalidraw/최신 디지털 공학.md#^group=AAVR3Ijf]]
### 동기 통신과 비동기 통신
![[Pasted image 20250208174651.png|500]]
#### 동기 통신
- 송신측과 수식측이 **공유된 클럭신호**를 사용하여 데이터를 전송한다.
- 특징
	- 데이터 전송 타이밍이 정확하게 맞춰지므로 고속 전송에 유리하다.
	- 추가 클럭 선이 필요하기 때문에 회로 구성이 복잡해질 수 있다.
- 사용 예시
	- [[SPI]], [[I2C]] 등
#### 비동기 통신
- 별도의 클럭 신호 없이 송수신측이 미리 약속된 전송 속도(baud rate)로 데이터를 전송한다.
- start bit와 stop bit 가지고 데이터의 시작과 끝을 알린다.
- 대부분 외부로 선이 나와있는 경우 비동기 통신을 사용한다.
- 특징
	- 회로 구성과 배선이 간단하고 비용이 저렴하다.
	- 타이밍 오차가 발생할 수 있어 전송 속도에 한계가 있다.
- 사용 예시
	- UART(비동기), USART(동기)
### UART의 데이터 통신 동작 원리
![[Excalidraw/Board Study.md#^group=8P0J8ZFtViS01OXRuzotj]]
#### 기본 구성 요소
- TX (Transmit) 라인
	- 송신 측에서 데이터를 보내는 선
	- Idle 상태: 데이터 전송이 없을 때 TX는 **HIGH 상태**를 유지한다.
- RX (Receive) 라인
	- 수신 측에서 데이터를 받는 선
	- 수신기는 TX에서 오는 신호를 감시한다.
#### UART의 데이터 프레임 구성
![[Pasted image 20250208175720.png|500]]
- Start Bit
	- 목적: 데이터의 전송 시작을 알린다.
	- 동작: Idle 상태(HIGH, 1)에서 LOW(0)으로 전환된다.
- Data Bit
	- 목적: 실제 전송할 데이터를 포함한다.
	- 구성: 일반적으로 7비트 또는 8비트로 구성된다.
	- 특징: **LSB(Least Significant Bit, 최하위 비트)** 부터 전송한다.
- Parity Bit(optional)
	- 목적: 간단하게 오류 검출을 하기위해 사용한다.
	- 특징: 필요에 따라 추가할 수 있다.
- Stop Bit
	- 목적: 데이터 전송의 끝을 알린다.
	- 동작: HIGH상태를 유지하며 일반적으로 1비트 또는 2비트 길이로 전송된다.
	- 특징: 수신측이 프레임의 종료를 인식하는 비트이다.
### 동작 과정 요약
![[Pasted image 20250208180323.png|500]]
- Idle 상태
	- TX 라인은 데이터가 전송되고 있지 않을 때 HIGH 상태를 유지한다.
- 데이터 전송 시작
	- TX 라인은 Idle 상태에서 Start Bit(0)를 보내고 LOW로 전환한다.
	- 수신기는 Start Bit를 받고 데이터 프레임이 시작되었음을 인식한다.
- 데이터 전송
	- 송신기는 정해진 순서대로 데이터 비트를 전송한다.
	- 수신기는 미리 정한 보율([[baud rate]])에 따라 각 비트를 [[샘플링]]한다.
- 데이터 전송 종료
	- 송신기는 Stop Bit를 전송하며 TX 라인을 다시 HIGH 상태로 복귀시킨다.
		- Idle 상태로 전환
## 오버샘플링
- 오버샘플링은 서로 다른 클럭을 맞춰주기 위한 기법이다.
![[Pasted image 20250208181319.png|500]]
- Start Bit 감지
	- 수신기는 HIGH 보던 RX라인이 LOW 떨어지는 순간을 **동기 신호**로 잡는다.
- 내부 [[오실레이터]]로 시간 측정
	- 수신기는 내부 오실레이터([[Clock]])을 사용하여 각 비트 시간([[baud rate]]) 간격을 계산한다.
- 오버샘플링 후 비트 결정
	- 한 비트 시간을 여러 구간(ex: 16분할)으로 나누어 여러 번 샘플링한다.
	- 중앙 값 부근의 샘플을 보고 해당 비트를 0인지 1인지 판정한다.
	- RX 라인은 Falling edge 감지 이후, 1.5 비트 이후의 데이터를 받아들인다.
- 프레임 복원
	- Start 비트 감지 이후 같은 방법으로 data bit와 stop bit를 읽고 최종 데이터(byte)를 복원한다.
#### baud rate의 계산
$$
BaudRate = \frac{f_{CLK}}{16 \times USARTDIV}
$$
$$
USARTDIV = \frac{f_{CLK}}{16 \times BaudRate}
$$

## 실습 
### MCU - PC 통신
- 핀 설정 및 세팅
- ioc 설정에서 USART1를 Asynchronous로 설정해준다.
	- PA9(TXD)와 PA10(RXD)이 활성화 된다.
- 전역(USER CODE BEGIN 2와 END 2 사이)
	- 데이터를 받아 저장할 Receive 버퍼를 전역으로 선언한다.
	- Receive의 상태값을 반환하는 변수를 전역으로 선언한다.
	- 에 해당 코드를 삽입한다.
```C
// Receive 버퍼 
uint8_t R_buffer[10]; 
// Echoing 시, 보드에서 온 값을 확인하기 위한 후첨자
char StmMessage[12] = "-BY STM\r\n"; 
// HAL에서 현재 스트림의 상태를 세팅해준다. 
// Read의 상태를 조회할 수 있다.
HAL_StatusTypeDef serial_status;
```
- while문(USER CODE BEGIN 3와 END 3 사이)
	- 보드가 반복적으로 실행할 코드를 작성해준다. 
```c
// 버퍼에서 1바이트를 recive
// 100초간 기다리고 읽은 경우 HAL_OK값과 일치
serial_status = HAL_UART_Receive(&huart2, R_buffer, 1, 100); 
if (serial_status == HAL_OK) { 
	// 읽은 1바이트 전송
	HAL_UART_Transmit(&huart2, R_buffer, 1, 100); 
	// 후첨자 -BY STM 전송
	HAL_UART_Transmit(&huart2, (uint8_t *)StmMessage, 12, 100); 
}
```

![[Pasted image 20250206191150.png|500]]
- 2바이트 이상을 전송했을 때 2바이트만 읽는 이유
	- Hercules로 전송한 데이터는 디버그용 보드의 칩과 USB 통신으로 전송된다.
	- 디버그용 보드는 UART통신으로 Main 보드의 칩으로 전송한다.
	- 각 레지스터 크기(내부 버퍼), 송신 간 딜레이 때문으로 추측한다.

### Interrupt를 이용한 통신
- GPIO에서 진행한 실습과 크게 다르지 않아 건너뛴다.
### 보드간 통신(polling)
- 영상으로 정리.
- 폴링방식을 잘 사용하지 않는다.
	- polling
		- while을 계속 돌며 timeout 시간 동안만 blocking
		- timeout 동안 읽지 못한 경우 Error 상태를 세팅하고 반환
	- blocking
		- read(Receive)를 할 때까지 blocking
- 보드 간 그라운드를 맞춰주는 이유
	- 그라운드는 완전한 0이 아니다.
		- 기기별로 논리적으로 0으로 삼을 전압이 상이하다.
	- 그라운드를 서로 연결해줌으로써 그라운드 값을 통일한다.
![[Excalidraw/Board Study.md#^group=wd6spBw4s_e4lKaiSa--A]]
#### 핀 맵
- 핀맵을 보고 UART에서 사용하는 TXD 핀과 RXD 핀을 각 보드마다 교차로 연결해주어야 한다.

![[Pasted image 20250206200133.png|500]]

---
### 생각(파생된 질문/생각)

### 출처

### 연결 문서 (연결 이유)
