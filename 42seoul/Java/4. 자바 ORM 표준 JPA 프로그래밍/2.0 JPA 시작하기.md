---
날짜: 2024-06-19
넘버: 
태그: 프로그래밍
저자: 김영한
출처: https://www.inflearn.com/course/ORM-JPA-Basic/dashboard
aliases:
---
### 날짜:  2024-06-19 19:16

### 태그: #프로그래밍 #자바 #스프링

>[!메모]
>

### 원문
---
# JPA 시작하기
- h2 데이터베이스 사용
### 데이터베이스 방언
- JPA는 특정 데이터베이스에 종속되지 않는다.
- 각각 데이터베이스가 제공하는 SQL 문법과 함수가 조금씩 다르다.
	- 가변 문자
		- MySQL: VARCHAR
		- Oracle: VARCHAR2
	- 문자열 자르는 함수
		- SQL: SUBSTRING()
		- Oracle: SUBSTR()
	- 페이징
		- MySQL: LIMIT
		- Oracle: ROWNUM
```java
<property name="hibernate.dialect" value="org.hibernate.dialect.H2Dialect"/>
```
- `direct.h2`를 통해서 개발 할 것이라는 걸 알려준다.
## JPA 구동 방식
![[Excalidraw/Java JPA.md#^group=HvS_A-KN-arkmIlGb01T8]]
## 애플리케이션 개발
```java 
public static void main(String[] args) {
	EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello"); // 애플리케이션 구동 시점에 하나만 등록 되어있어야 한다.
	EntityManager em = emf.createEntityManager();

	EntityTransaction tx = em.getTransaction();
	tx.begin();
	try {
		Member member = new Member();
		member.setId(2L);
		member.setName("HelloBro");
		em.persist(member);
		tx.commit();
	} catch(Exception e){
		tx.rollback();
	} finally {
		em.close();
	}
	emf.close();
}
```
- entity를 저장하거나 처리하는 로직은 transaction안에서 처리되어야 한다.
- transaction을 try-catch로 감싼 이유
	- 실패한 경우 데이터를 롤백해주고 entity manager를 닫아줄 수 있어야 한다.
 > [!tip]
 > 애플리케이션 구동 시 drop table 하도록 하는 속성을 변경해주어야 한다.
 > `persistence.xml`에서 아래의 항목이 있다면 주석처리 해주어야 한다.
 > - `<property name="hibernate.hbm2ddl.auto" value="create" />` 
### 값 조회 및 변경
```java
public static void main(String[] args) {
	EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");
	EntityManager em = emf.createEntityManager();

	EntityTransaction tx = em.getTransaction();
	tx.begin();
	try {
		Member member = em.find(Member.class, 1L);
		System.out.println("member.getName() = " + member.getName());
		member.setName("JPA");

		tx.commit();
	} catch(Exception e){
		System.out.println("e = " + e);
		tx.rollback();
	} finally {
		em.close();
	}
	emf.close();
}
```
- em.find()를 통해 찾아온 객체는 JPA에 의해 관리된다.
	- 변경 되었는지 체크하여 update 쿼리를 날려준다.
### entity manager factory VS entity manager
- entity manger factory
	- 하나만 생성하여 애플리케이션 전체에서 공유한다.
- entity manager
	- 고객의 요청이 올 때마다 생성하여 사용한다.
	- **절대 스레드 간에 공유가 일어나면 안 된다**.
- JPA 모든 데이터 변경은 트랜잭션 안에서 실행되어야 한다.
## JPQL
- JPA는 SQL을 추상화한 JPQL이라는 객체지향 쿼리 언어를 제공한다.
	- JPQL은 엔티티 객체를 대상으로 쿼리한다.
	- SQL은 데이터베이스 테이블을 대상으로 쿼리한다.
- SQL 문법과 유사하다. `SELECT`, `FROM`, `WHERE`, `GROUP BY`, `HAVING`, `JOIN`을 지원한다.
- JPQL은 쿼리를 테이블을 대상으로 작성하는 것이 아니라 객체를 대상으로 작성한다.
### 전체 회원 조회
```java
select
            m1_0.id,
            m1_0.name 
        from
            Member m1_0  

for (Member member: members) {  
	System.out.println(member.getName());  
}  
```
- output
```console
Hibernate: 
    /* select
        m 
    from
        Member as m */ select
            m1_0.id,
            m1_0.name 
        from
            Member m1_0
member 2
member 1
member 3
```
- 실제 나간 쿼리
	- `select m1_0.id, m1_0.name from Member m1_0`
### pagenation
```java
List<Member> members = em.createQuery("select m from Member as m", Member.class)  
        .setFirstResult(3)  
        .setMaxResults(5)  
        .getResultList();
```
- output
```console
Hibernate: 
    /* select
        m 
    from
        Member as m */ select
            m1_0.id,
            m1_0.name 
        from
            Member m1_0 
        offset
            ? rows 
        fetch
            first ? rows only
member 4
member 5
member 6
```
### 검색쿼리
- 검색 또한 테이블이 아닌 엔티티 객체를 대상으로 검색한다.
- 모든 DB 데이터를 객체로 변환해서 검색하는 것은 불가능하다.
- 애플리케이션이 필요한 데이터만 DB에서 불러오려면 결국 검색 조건이 포함된 SQL이 필요하다.

---
### 생각(파생된 질문/생각)

### 출처
- [자바 ORM 표준 JPA 프로그래밍 - 기본편](https://www.inflearn.com/course/ORM-JPA-Basic/dashboard)

### 연결 문서 (연결 이유)
