---
날짜: 2024-08-22
넘버: 
태그: 프로그래밍
저자: Eazy Bytes
출처: https://www.udemy.com/course/master-microservices-with-springboot-docker-kubernetes-korean/
aliases:
---
### 날짜:  2024-08-22 14:52

### 태그: #프로그래밍 #자바 #스프링

>[!메모]
>

### 원문
---
# 클라이언트 자격 증명 흐름
- 통신 유형에 따라 보안을 구축하는 여러가지 흐름이 있다.
	- 어떤 시나리오에서 어떤 플로우를 따라야 하는지 알아야 한다.
## 두 개의 API가 서로 다른 백엔드 서버에서 통신을 시도하려는 경우
### 용어 설명
- 인증 서버(auth server): 클라이언트 애플리케이션을 인증하고 액세스 토큰을 발급한다.
	- Keycloak을 사용하여 인증 서버를 설정할 것이다.
- 리소스 서버: 게이트웨이 서버를 리소스서버로 동작하게 한다.
	- 리소스 서버는 인증 서버에서 인증을 받았는지 확인하고 안 되어있다면 인증을 받는다. 
- 클라이언트: 클라이언트 애플리케이션
	- 클라이언트는 인증을 받은 후, 인증 서버에서 액세스 토큰을 발급 받아서 리소스 서버로 접근해야 한다.
	- 리소스 서버는 클라이언트로부터 받은 액세스 토큰이 유효한 경우에만 응답한다.
### flow
![[Excalidraw/Java MSA.md#^group=AeOYRTWq]]
- 클라이언트는 리소스 서버에 보호된 자원을 요청했지만, Access 토큰이 없어서 응답받지 못했다.
- 인증 서버에 Access 토큰을 발급받기 위해 자신의 credential을 제공했다.
	- 클라이언트 ID / PW
	- 여기서 **클라이언트 애플리케이션**은 리소스 서버를 호출하려는 **다른 백엔드 애플리케이션** 또는 **API**, **외부 마이크로서비스**를 의미한다.
		- 사용자가 관여하지 않는 다는 점이 중요하다.
- 인증 서버가 자격 증명을 확인하고 Access 토큰을 발급한다.
- 클라이언트는 해당 토큰을 리소스 서버에 요청과 함께 전달한다.
- 리소스 서버는 해당 토큰의 유효성을 판단한다.
- 리소스 서버는 클라이언트 애플리케이션이 특정 secure API 또는 secure resource에 접근할 수 있는 권한이 있는지 확인한 뒤 응답한다.
### 정리
- 클라이언트 애플리케이션은 인증 서버에 액세스 토큰을 요청할 떄마다 클라이언트 ID/PW를 제공해야 한다.
	- ciient_id & client_secret: 인증 서버에 등록하는 과정과 동일한 요청에서 받을 수 있는 정보이다.
	- scope: 요청하는 범위의 세부 정보도 포함해야 한다.
		- 클라이언트 애플리케이션이 이메일을 요청하고 있다면 범위는 이메일이 될 것이다.
		- 인증 서버는 클라이언트가 요청하는 스코프를 전부 제공하지 않는다.
			- 클라이언트를 인증 서버에 등록하는 동안 인증 서버의 관리자는 Keycloak 서버와 같은 인증 서버에서 해당 클라이언트 ID에 대해 특정 범위만 허용하도록 구성을 할 것이다.
			- 클라이언트가 요청하는 스코프의 목록은 인증 서버 내부의 스코프 목록과 일치해야 한다.
	- grant_type: 클라이언트의 자격증명 값을 제공한다.
- 이 시나리오에서 인증 서버는 사용자의 자격 증명을 요청하지 않는다.
	- 해당 시나리오에서는 end user 또는 resource owner가 관여하지 않는다.
	- 백엔드 서버끼리의 통신을 정의하는 가장 간단한 시나리오 이다.

## 게이트웨이 서버를 보호하는 방법
- 1. 클라이언트는 클라이언트 자격증명을 통해 인증 서버에서 액세스 토큰을 얻는다.
	- 키클럭 관리자와 협력하여 자신을 유효한 클라이언트 애플리케이션으로 등록해야 한다.
	- 키클럭 관리자 또는 비즈니스 리더가 승인한 외부 클라이언트 애플리케이션만 인증 서버 및 게이트웨이와 통신할 수 있어야 한다.
- 2. 클라이언트 애플리케이션은 발급받은 액세스 토큰을 통해 게이트웨이 내부에서 사용가능한 API를 호출한다.
	- 여기서 우리는 게이트웨이 서버를 리소스 서버로 만들 것이다.
	- 리소스 서버는 유효한 액세스 토큰이 없는 요청에 응답해서는 안 된다.
- 3. 리소스 서버는 인증 서버에 액세스 토큰이 유효한지 확인한다.
- 4. 유효하다면 요청받은 특정 마이크로서비스에 연결한다.
	- 특정 마이크로서비스(accounts, loans, cards)는 어떻게 보호되는가?
		- 해커, 악성 클라이언트 애플리케이션이 있을 수 있다.
		- 하지만 방화벽 또는 도커 네트워크 뒤에 마이크로서비스를 배치함으로써 직접 통신할 수 없도록 할 것이다.
	- 게이트웨이만 end point로 제공한다.
	- 개별 마이크로서비스를 리소스 서버로 등록하게 된다면 인증과 관련된 로직들에 흐름의 복잡성과 성능의 저하가 일어날 것이다.
		- 보안이 필요 없다는 이야기는 아니다. 이후 쿠버네티스 클러스터에 배포할 때 설명을 할 것이다.



---
### 생각(파생된 질문/생각)

### 출처
- [유데미 - Java, Spring Boot, Spring Cloud, Docker, Kubernetes, Helm, 마이크로서비스 보안](https://www.udemy.com/course/master-microservices-with-springboot-docker-kubernetes-korean/)

### 연결 문서 (연결 이유)
