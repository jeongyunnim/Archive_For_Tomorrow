---
날짜: '"2023-11-03"'
넘버: 
태그: 
출처: https://docs.docker.com/get-started/09_image_best/
aliases:
---
### 날짜  2023-11-03 21:31

### 태그:

>[!메모]
>

### 원문
---
## Image layering
- `docker image history`를 사용하여 이미지의 각 레이어를 만드는 데 사용된 명령을 확인할 수 있다.
1. `docker image history` 생성한 시작 이미지의 레이어를 확인한다.
```bash
$> docker image history getting-started
IMAGE          CREATED              CREATED BY                                      SIZE      COMMENT
2901a4bd1946   38 seconds ago       EXPOSE map[3000/tcp:{}]                         0B        buildkit.dockerfile.v0
<missing>      38 seconds ago       CMD ["node" "src/index.js"]                     0B        buildkit.dockerfile.v0
<missing>      38 seconds ago       RUN /bin/sh -c yarn install --production # b…   83.1MB    buildkit.dockerfile.v0
<missing>      47 seconds ago       COPY . . # buildkit                             59.7MB    buildkit.dockerfile.v0
<missing>      About a minute ago   WORKDIR /app                                    0B        buildkit.dockerfile.v0
<missing>      2 weeks ago          /bin/sh -c #(nop)  CMD ["node"]                 0B
<missing>      2 weeks ago          /bin/sh -c #(nop)  ENTRYPOINT ["docker-entry…   0B
<missing>      2 weeks ago          /bin/sh -c #(nop) COPY file:4d192565a7220e13…   388B
<missing>      2 weeks ago          /bin/sh -c apk add --no-cache --virtual .bui…   7.77MB
<missing>      2 weeks ago          /bin/sh -c #(nop)  ENV YARN_VERSION=1.22.19     0B
<missing>      2 weeks ago          /bin/sh -c addgroup -g 1000 node     && addu…   162MB
<missing>      2 weeks ago          /bin/sh -c #(nop)  ENV NODE_VERSION=18.18.2     0B
<missing>      5 weeks ago          /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B
<missing>      5 weeks ago          /bin/sh -c #(nop) ADD file:756183bba9c7f4593…   7.34MB
```
- 각 줄은 이미지의 레이어를 나타낸다. 상단에 최신 레이어가 표시된다.
- `no-trunc` 플래그를 추가하면 전체 출력을 얻을 수 있다.
## Layer caching
- 컨테이너 이미지의 빌드를 단축시키는 방법
	- 레이어가 변경되면 모든 다운스트림 레이어도 다시 만들어야 한다.
```dockerfile
# syntax=docker/dockerfile:1
FROM node:18-alpine
WORKDIR /app
COPY . .
RUN yarn install --production
CMD ["node", "src/index.js"]
```
- image history의 출력을 보면 dockerfile의 각 명령이 이미지에서 새 레이어가 되는 것을 볼 수 있다. 따라서 이미지를 변경할 때 종속 요소를 다시 설치하고 있다는 것을 알 수 있다.
	- 빌드를 할 때마다 동일한 종속 요소를 배포하는 것은 비합리적이다.
- 이를 해결하기 위해 종속성 캐싱을 지원하도록 Dockerfile을 재구성하면 된다. 노드 기반 애플리케이션의 경우 package.json 파일에 정의하면 된다.
	- 먼저 해당 파일만 복사하고 종속 요소를 설치한 다음, 다른 모든 파일을 복사할 수 있다.
	- package.json에 변경사항이 있는 경우에만 yarn 종속성을 다시 생성한다.
```bash
➜  getting-started-app git:(main) ✗ docker build -t getting-started .
[+] Building 9.8s (13/13) FINISHED
 => [internal] load build definition from Dockerfile                                                                                                 0.0s
 => => transferring dockerfile: 208B                                                                                                                 0.0s
 => [internal] load .dockerignore                                                                                                                    0.0s
 => => transferring context: 2B                                                                                                                      0.0s
 => resolve image config for docker.io/docker/dockerfile:1                                                                                           0.7s
 => CACHED docker-image://docker.io/docker/dockerfile:1@sha256:ac85f380a63b13dfcefa89046420e1781752bab202122f8f50032edf31be0021                      0.0s
 => [internal] load build definition from Dockerfile                                                                                                 0.0s
 => [internal] load metadata for docker.io/library/node:18-alpine                                                                                    0.0s
 => [internal] load .dockerignore                                                                                                                    0.0s
 => [1/4] FROM docker.io/library/node:18-alpine                                                                                                      0.0s
 => [internal] load build context                                                                                                                    0.2s
 => => transferring context: 458.47kB                                                                                                                0.2s
 => CACHED [2/4] WORKDIR /app                                                                                                                        0.0s
 => [3/4] COPY . .                                                                                                                                   0.5s
 => [4/4] RUN yarn install --production                                                                                                              7.3s
 => exporting to image                                                                                                                               0.9s
 => => exporting layers                                                                                                                              0.9s
 => => writing image sha256:7f4c64ecaa085b0dc24841b6d0e9eee2b0a43b4e4e6d6f9abcc907af4b2f8acd                                                         0.0s
 => => naming to docker.io/library/getting-started                                                                                                   0.0s

Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them
➜  getting-started-app git:(main) ✗ docker build -t getting-started .
[+] Building 1.0s (14/14) FINISHED
 => [internal] load build definition from Dockerfile                                                                                                 0.0s
 => => transferring dockerfile: 206B                                                                                                                 0.0s
 => [internal] load .dockerignore                                                                                                                    0.0s
 => => transferring context: 2B                                                                                                                      0.0s
 => resolve image config for docker.io/docker/dockerfile:1                                                                                           0.6s
 => CACHED docker-image://docker.io/docker/dockerfile:1@sha256:ac85f380a63b13dfcefa89046420e1781752bab202122f8f50032edf31be0021                      0.0s
 => [internal] load build definition from Dockerfile                                                                                                 0.0s
 => [internal] load metadata for docker.io/library/node:18-alpine                                                                                    0.0s
 => [internal] load .dockerignore                                                                                                                    0.0s
 => [1/5] FROM docker.io/library/node:18-alpine                                                                                                      0.0s
 => [internal] load build context                                                                                                                    0.2s
 => => transferring context: 458.47kB                                                                                                                0.2s
 => CACHED [2/5] WORKDIR /app                                                                                                                        0.0s
 => CACHED [3/5] COPY package.json yarn.lock ./                                                                                                      0.0s
 => CACHED [4/5] RUN yarn install --production                                                                                                       0.0s
 => CACHED [5/5] COPY . .                                                                                                                            0.0s
 => exporting to image                                                                                                                               0.0s
 => => exporting layers                                                                                                                              0.0s
 => => writing image sha256:915948cc89fcab3921650e025841a5d07c6481339daf27c36ef89ec5822dc2c0                                                         0.0s
 => => naming to docker.io/library/getting-started                                                                                                   0.0s

Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them
```

---
### 생각(파생된 질문/생각)

### 출처
- https://docs.docker.com/get-started/09_image_best/

### 연결 문서 (연결 이유)
